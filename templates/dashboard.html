{% extends "base.html" %}

{% block title %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - æ ªãƒãƒƒãƒ—ãƒ„ãƒªãƒ¼{% endblock %}

{% block content %}<style>
    .clickable-row { cursor: pointer; }
    .sortable:hover { background-color: #f8f9fa; }
    .text-end { text-align: right !important; }
    #analysis_text { min-height: 200px; }
    #analysis_content, #memoContent { white-space: pre-wrap; overflow-wrap: break-word; }</style><div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
        <p class="mb-0">ã“ã‚“ã«ã¡ã¯ã€{{ username }}ã•ã‚“ï¼</p>
    </div>
    <div class="card text-center mb-4 border-primary border-2">
        <div class="card-body">
            <h5 class="card-title">æ–°ã—ã„æŠ•è³‡ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’æ¢ã™</h5>
            <p class="card-text">ã€Œé€£æƒ³ãƒ¢ãƒ¼ãƒ‰ã€ã‚„ã€Œãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ã€ã‚’ä½¿ã£ã¦ã€æ–°ã—ã„æŠ•è³‡ã®ãƒ’ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†ã€‚</p>
            <a href="{{ url_for('idea_prism') }}" class="btn btn-primary">ã‚¢ã‚¤ãƒ‡ã‚¢ãƒ»ãƒ—ãƒªã‚ºãƒ ã¸</a>
        </div>
    </div>
    <div class="card mb-4">
        <div class="card-header">æ–°ã—ã„éŠ˜æŸ„ã‚’è¿½åŠ </div>
        <div class="card-body">
            <form method="post">
                <div class="mb-3">
                    <label for="ticker" class="form-label">ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚·ãƒ³ãƒœãƒ« (ä¾‹: 7203.T ãƒˆãƒ¨ã‚¿, AAPL Apple):</label>
                    <input type="text" class="form-control" id="ticker" name="ticker" required>
                </div>
                <div class="mb-3">
                    <label for="memo" class="form-label">ãƒ¡ãƒ¢:</label>
                    <textarea class="form-control" id="memo" name="memo" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label for="analysis_text" class="form-label">åˆ†æå†…å®¹:</label>
                    <div class="input-group">
                        <textarea class="form-control" id="analysis_text" name="analysis_text" rows="8"></textarea>
                    </div>
                    <div class="d-flex justify-content-end mt-2">
                        <button type="button" id="generate-analysis-btn" class="btn btn-sm btn-outline-primary">
                            <span id="analysis-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                            <span id="analysis-btn-text">AIã§éŠ˜æŸ„ã‚’åˆ†æ</span>
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label d-block">è©•ä¾¡:</label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" id="buy" name="rating" value="è²·ã„" checked>
                        <label class="form-check-label" for="buy">è²·ã„</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" id="neutral" name="rating" value="ä¸­ç«‹">
                        <label class="form-check-label" for="neutral">ä¸­ç«‹</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" id="sell" name="rating" value="å£²ã‚Š">
                        <label class="form-check-label" for="sell">å£²ã‚Š</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
            </form>
        </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>ãƒã‚¤ãƒªã‚¹ãƒˆ</h3>
        <div class="d-flex gap-2">
            <a href="{{ url_for('update_financial_data') }}" class="btn btn-sm btn-outline-secondary">ğŸ“ˆ æ ªä¾¡ãƒ»æŒ‡æ¨™ã‚’æ›´æ–°</a>
            <a href="{{ url_for('update_analysis_data') }}" class="btn btn-sm btn-outline-primary" onclick="return confirm('å…¨éŠ˜æŸ„ã®åˆ†ææ›´æ–°ã«ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ');">ğŸ¤– AIåˆ†æã‚’æ›´æ–°</a>
        </div>
    </div>

    <form method="get" class="row g-3 align-items-center mb-3 p-3 bg-light rounded">
        <div class="col-md-5">
            <label for="filter_sector" class="form-label">ã‚»ã‚¯ã‚¿ãƒ¼ã§çµã‚Šè¾¼ã¿:</label>
            <select name="filter_sector" id="filter_sector" class="form-select">
                <option value="">ã™ã¹ã¦ã®ã‚»ã‚¯ã‚¿ãƒ¼</option>
                {% for sector in unique_sectors %}
                <option value="{{ sector }}" {% if sector == current_filters.sector %}selected{% endif %}>{{ sector }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-5">
            <label for="filter_rating" class="form-label">è©•ä¾¡ã§çµã‚Šè¾¼ã¿:</label>
            <select name="filter_rating" id="filter_rating" class="form-select">
                <option value="">ã™ã¹ã¦ã®è©•ä¾¡</option>
                <option value="è²·ã„" {% if 'è²·ã„' == current_filters.rating %}selected{% endif %}>è²·ã„</option>
                <option value="ä¸­ç«‹" {% if 'ä¸­ç«‹' == current_filters.rating %}selected{% endif %}>ä¸­ç«‹</option>
                <option value="å£²ã‚Š" {% if 'å£²ã‚Š' == current_filters.rating %}selected{% endif %}>å£²ã‚Š</option>
            </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">çµã‚Šè¾¼ã¿</button>
        </div>
    </form>
    
    {% if stocks %}
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th class="sortable"><a href="{{ url_for('dashboard', sort_by='company_name', order='asc' if current_sort.by == 'company_name' and current_sort.order == 'desc' else 'desc') }}">ä¼æ¥­å(æ—¥æœ¬èª)</a></th>
                        <th class="sortable"><a href="{{ url_for('dashboard', sort_by='company_name_en', order='asc' if current_sort.by == 'company_name_en' and current_sort.order == 'desc' else 'desc') }}">ä¼æ¥­å(è‹±èª)</a></th>
                        <th class="sortable"><a href="{{ url_for('dashboard', sort_by='ticker', order='asc' if current_sort.by == 'ticker' and current_sort.order == 'desc' else 'desc') }}">ãƒ†ã‚£ãƒƒã‚«ãƒ¼</a></th>
                        <th class="sortable"><a href="{{ url_for('dashboard', sort_by='rating', order='asc' if current_sort.by == 'rating' and current_sort.order == 'desc' else 'desc') }}">è©•ä¾¡</a></th>
                        <th class="text-end">ç¾åœ¨æ ªä¾¡</th>
                        <th class="text-end sortable"><a href="{{ url_for('dashboard', sort_by='performance', order='asc' if current_sort.by == 'performance' and current_sort.order == 'desc' else 'desc') }}">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</a></th>
                        <th class="text-end sortable"><a href="{{ url_for('dashboard', sort_by='per', order='asc' if current_sort.by == 'per' and current_sort.order == 'desc' else 'desc') }}">äºˆæƒ³PER(å€)</a></th>
                        <th class="text-end sortable"><a href="{{ url_for('dashboard', sort_by='pbr', order='asc' if current_sort.by == 'pbr' and current_sort.order == 'desc' else 'desc') }}">PBR(å€)</a></th>
                        <th class="text-end sortable"><a href="{{ url_for('dashboard', sort_by='dividend_yield', order='asc' if current_sort.by == 'dividend_yield' and current_sort.order == 'desc' else 'desc') }}">é…å½“åˆ©å›ã‚Š</a></th>
                        <th>å¤‰æ›´ç‚¹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in stocks %}
                    <tr class="clickable-row" data-bs-toggle="modal" data-bs-target="#memoModal" 
                        data-company="{{ stock.company_name }}" 
                        data-memo="{{ stock.memo or '' }}"
                        data-analysis="{{ stock.analysis_text or '' }}">
                        <td>{{ stock.company_name }}</td>
                        <td>{{ stock.company_name_en }}</td>
                        <td>{{ stock.ticker }}</td>
                        <td>{{ stock.rating }}</td>
                        <td class="text-end">{{ "%.2f"|format(stock.current_price) if stock.current_price is not none else 'N/A' }}</td>
                        <td class="text-end fw-bold {% if stock.performance >= 0 %}text-success{% else %}text-danger{% endif %}">{{ "%.2f"|format(stock.performance) }}%</td>
                        <td class="text-end">{{ "%.2f"|format(stock.per) if stock.per is not none else 'N/A' }}</td>
                        <td class="text-end">{{ "%.2f"|format(stock.pbr) if stock.pbr is not none else 'N/A' }}</td>
                        <td class="text-end">
                            {% if stock.dividend_yield is not none %}
                                {{ "%.2f"|format(stock.dividend_yield) }}%
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if stock.has_update %}
                                <span class="text-danger fw-bold">â—</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('edit_stock', stock_id=stock.id) }}" class="btn btn-sm btn-outline-primary">ç·¨é›†</a>
                                <form action="{{ url_for('delete_stock', stock_id=stock.id) }}" method="post" class="d-inline" onclick="event.stopPropagation();">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">å‰Šé™¤</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-secondary">ã¾ã ãƒã‚¤ãƒªã‚¹ãƒˆã«éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
    {% endif %}</div><div class="modal fade" id="memoModal" tabindex="-1" aria-labelledby="memoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="memoModalLabel">è©³ç´°æƒ…å ±</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h6>åˆ†æå†…å®¹</h6>
        <div id="analysis_content" class="p-2 bg-light rounded mb-3"></div>
        <hr>
        <h6>å€‹äººãƒ¡ãƒ¢</h6>
        <p id="memoContent"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div></div>
{% endblock %}

{% block scripts %}<script>document.addEventListener('DOMContentLoaded', function() {
    const memoModal = document.getElementById('memoModal');
    if (memoModal) {
        memoModal.addEventListener('show.bs.modal', function (event) {
            const row = event.relatedTarget;
            const companyName = row.getAttribute('data-company');
            const memoText = row.getAttribute('data-memo');
            const analysisText = row.getAttribute('data-analysis');

            const modalTitle = memoModal.querySelector('.modal-title');
            const memoBody = memoModal.querySelector('#memoContent');
            const analysisBody = memoModal.querySelector('#analysis_content');
            
            modalTitle.textContent = companyName + ' ã®è©³ç´°æƒ…å ±';
            
            if (analysisText) {
                analysisBody.textContent = analysisText;
            } else {
                analysisBody.textContent = 'ï¼ˆåˆ†æå†…å®¹ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰';
            }

            if (memoText) {
                memoBody.textContent = memoText;
            } else {
                memoBody.textContent = 'ï¼ˆãƒ¡ãƒ¢ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰';
            }
        });
    }

    const analysisBtn = document.getElementById('generate-analysis-btn');
    if(analysisBtn) {
        analysisBtn.addEventListener('click', async function() {
            const tickerInput = document.getElementById('ticker');
            const ticker = tickerInput.value;
            if (!ticker) {
                alert('å…ˆã«ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚·ãƒ³ãƒœãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const analysisTextArea = document.getElementById('analysis_text');
            const spinner = document.getElementById('analysis-spinner');
            const btnText = document.getElementById('analysis-btn-text');

            this.disabled = true;
            spinner.style.display = 'inline-block';
            btnText.textContent = 'åˆ†æä¸­...';
            analysisTextArea.value = 'GeminiãŒåˆ†æã‚’ç”Ÿæˆä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...';

            try {
                const formData = new FormData();
                formData.append('ticker', ticker);

                const response = await fetch('/generate_analysis', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    analysisTextArea.value = result.analysis_text;
                } else {
                    throw new Error(result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
                }
            } catch (error) {
                console.error('Analysis generation failed:', error);
                analysisTextArea.value = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n' + error.message;
            } finally {
                this.disabled = false;
                spinner.style.display = 'none';
                btnText.textContent = 'AIã§éŠ˜æŸ„ã‚’åˆ†æ';
            }
        });
    }
});</script>
{% endblock %}